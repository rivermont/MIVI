---
title: "MIVI"
author: "Will Bennett"
date: "12/02/2023"
output: pdf_document
---

# Japanese Stiltgrass (Microstegium vimineum)
# Effects of Latitude and Elevation on Seeding Time

Data source: iNaturalist ([link](https://www.inaturalist.org/taxa/116710-Microstegium-vimineum))<br/>  
Total observations (NA): 14,992<br/>  
Observations needing phenology annotation: 8,316

### Setup

```{R, message=FALSE}
# set lwd
setwd("~/Documents/MIVI/")

library(dplyr)
library(ggplot2)
library(elevatr)
library(corrtable)
library(table1)
library(knitr)

# number of groups for analysis
n = 180
```


# Loading data

## Export iNaturalist Data

1. Export all _Microstegium vimineum_ observations from iNat with columns (`id`, `observed_on`, `latitude`, `longitude`, `place_state_name`, `place_country_name`):
[Link](https://www.inaturalist.org/observations/export?quality_grade=research&identifications=any&geoprivacy=open&place_id=97394&taxon_id=116710&verifiable=true&acc_below_or_unknown=28000)
<!--  -->

2. Export all _M. vimineum_ observations with phenology 'No Evidence of Flowering' with column `id`:
[Link](https://www.inaturalist.org/observations/export?quality_grade=research&identifications=any&geoprivacy=open&place_id=97394&taxon_id=116710&verifiable=true&acc_below_or_unknown=28000&term_id=12&term_value_id=21)

2. Export all _M. vimineum_ observations with phenology 'Flowering' with column `id`:
[Link](https://www.inaturalist.org/observations/quality_grade=research&identifications=any&geoprivacy=open&place_id=97394&taxon_id=116710&verifiable=true&acc_below_or_unknown=28000&term_id=12&term_value_id=13)

2. Export all _M. vimineum_ observations with phenology 'Fruiting' with column `id`:
[Link](https://www.inaturalist.org/observations/export?quality_grade=research&identifications=any&geoprivacy=open&place_id=97394&taxon_id=116710&verifiable=true&acc_below_or_unknown=28000&term_id=12&term_value_id=14)

<!--
Note: `?term_value=15` is flower budding
-->

```{R, eval=FALSE}
# 1
mivi_all <- read.csv("./MIVI-ALL.csv") %>%
    mutate(date=as.Date(observed_on, format="%Y-%m-%d")) %>% select(-observed_on) # %>%
    # select(-place_country_name)

# 2
mivi_young <- read.csv("MIVI-YOUNG.csv") %>%
    mutate(stage="Vegetation")

# 3
mivi_flowering <- read.csv("./MIVI-FLOWERING.csv") %>%
    mutate(stage="Flowering")

# 4
mivi_fruiting <- read.csv("./MIVI-FRUITING.csv") %>%
    mutate(stage="Seeding")


# join each based on id
mivi_all <- mivi_all %>% left_join(mivi_young, by="id")
mivi_all <- mivi_all %>% left_join(mivi_flowering, by="id") %>%
    mutate(stage = coalesce(stage.x, stage.y)) %>% select(-stage.x, -stage.y)
mivi_all <- mivi_all %>% left_join(mivi_fruiting, by="id") %>%
    mutate(stage = coalesce(stage.x, stage.y)) %>% select(-stage.x, -stage.y)

# memory cleanup
rm(mivi_young, mivi_flowering, mivi_fruiting)
```

### Or load from processed file

```{R}
mivi_all <- read.csv("./MIVI-PROCESSED.csv") %>% select(-X) %>%
    mutate(date=as.Date(date, format="%Y-%m-%d"))
```

## Data processing

```{R}
# remove known incorrect records
mivi_all <- subset(mivi_all, id != "130398055")

# Get Julian day
mivi_all <- mivi_all %>% mutate(julian = as.integer(strftime(date, format="%j")))

# make phenology a factor type (not necessary)
mivi_all$stage <- factor(mivi_all$stage, ordered=TRUE,
                         levels=c("Vegetation", "Flowering", "Seeding"))

# Select only observations with phenology data
mivi_annotated <- mivi_all %>% filter(!is.na(stage))

# Group into quartiles by latitude
mivi_annotated$group <- ntile(mivi_annotated$latitude, 4)
```


# Basic Descriptive Plots

```{R}
# Density of all observations by lat/lon
ggplot(mivi_all, aes(x=longitude,y=latitude)) + geom_point(alpha=0.25) +
    labs(title="Density of observations by location")

# Histogram of all observations by lat
ggplot(mivi_all, aes(x=latitude)) + geom_histogram(binwidth=0.2) +
    labs(title="Histogram of observations by latitude")

# Histogram with city labels
ggplot(mivi_all, aes(x=latitude)) + geom_histogram(binwidth=0.2) +
    geom_vline(xintercept=33.75) + annotate("text", x=33.5, y=850, label="Atlanta", angle=90) +
    geom_vline(xintercept=35.84) + annotate("text", x=35.59, y=850, label="Raleigh", angle=90) +
    geom_vline(xintercept=38.9) + annotate("text", x=38.65, y=850, label="Washington", angle=90) +
    geom_vline(xintercept=40.75) + annotate("text", x=41, y=850, label="New York", angle=90) +
    ylab("count") + labs(title="Histogram of observations by latitude")

# Boxplots of phenology by quartile (notches break hinges for Flowering)
# Slight earlier trend in Seeding visible
ggplot(mivi_annotated, aes(julian, stage)) + geom_boxplot() + facet_grid(~group) +
    coord_flip() + xlab("Julian day") + labs(title="Phenology stage, quartiles by latitude")
```

## Time Series Plots
```{R}
# Latitude against Julian day
ggplot(mivi_annotated, aes(julian, latitude)) + geom_point(aes(color=stage), alpha=0.5) +
    scale_color_hue() + xlab("Julian day") +
    labs(title="Annotated Observations by Latitude and Julian Day")

# Latitude against Julian day
# ggplot(mivi_all, aes(julian, latitude)) + geom_point(aes(color=stage), alpha=0.5) +
#     scale_color_hue() + xlab("Julian day") +
#     labs(title="Observations by Latitude and Julian Day")

# Time series by latitude, color by stage
ggplot(mivi_all, aes(date, latitude)) + geom_point(aes(color=stage), alpha=0.5) +
    scale_x_date(date_breaks = "1 year", date_labels = "%Y") + scale_color_hue() +
    labs(title="Observations by latitude over time")

# Zoom in on recent data
timeclip <- c(as.Date("2019-02-01"), as.Date("2023-11-30"))
ggplot(mivi_all, aes(date, latitude)) + geom_point(aes(color=stage), alpha=0.5) +
    scale_x_date(limits=timeclip, date_breaks = "1 year", date_labels = "%Y") + scale_color_hue() +
    labs(title="Observations by latitude over time (2019-2023)")
```


# Retrieve Elevation Information

```{R, eval=FALSE}
# TODO: replace elevation value with value from 'field:elevation (feet)'

coords <- data.frame(x=mivi_annotated$longitude,
                     y=mivi_annotated$latitude, ele_id=mivi_annotated$id)
# pipe to 'slice(1:100)' to get a subset for reducing retrieval time

# retrieve elevation from USGS (takes a while)
elevations <- get_elev_point(coords, prj=4326, src="epqs")

mivi_all <- mivi_all %>% left_join(elevations, by=join_by("id" == "ele_id")) %>%
    select(-elev_units, -geometry)

rm(coords, elevations)

write.csv(mivi_all, file="./MIVI-PROCESSED.csv", na='')
```


# Analysis!

```{R}
# Note: returns Inf if there are none in the selection
first_seed <- function(df) {
    df <- df %>% filter(stage == "Seeding")
    return (min(df$julian, na.rm=TRUE))
}
```

## Latitude

```{R}
# Create groups
mivi_annotated$group <- ntile(mivi_annotated$latitude, n)

# mean lat for each group
a <- mivi_annotated %>% group_by(group) %>% summarise(mlat=mean(latitude, na.rm=TRUE), minlat=min(latitude, na.rm=TRUE), maxlat=max(latitude, na.rm=TRUE))

# first seeding date in each group
b <- mivi_annotated %>% group_by(group) %>% group_map(~first_seed(.x))

a <- bind_cols(a, do.call(rbind.data.frame, b)[,1]) %>% mutate(fseed = ...5) %>% select(-...5)
a <- remove_missing(a, finite=TRUE)  # remove any Inf's

# Plot with linear model
print(
    ggplot(a, aes(mlat, fseed)) + geom_point() + geom_smooth(method='lm') +
        ylab("Julian day") + xlab("mean latitude") + labs(title="First Seeding Day by Latitude")
)

# Q-Q residual plot
model_lat <- lm(fseed~mlat, data=a)
res <- resid(model_lat)
qqnorm(res)
qqline(res)

print(n)
print(mad(res))

# Pearson's correlation test
cor.test(a$fseed, a$mlat, alternative="less")

correlation_matrix(a, use="lower")
# correlation_matrix(a, use="lower")$estimate

# kable(correlation_matrix(a, use="lower"), booktabs=TRUE, format="latex")
# kable(correlation_matrix(a, use="lower"), booktabs=TRUE)

rm(a, b, res, model_lat)
```

## Elevation

```{R}
# Create groups
mivi_annotated$group <- ntile(mivi_annotated$elevation, n)

# mean lat for each group
a <- mivi_annotated %>% group_by(group) %>% summarise(mele=mean(elevation, na.rm=TRUE))

# first seeding date in each group
b <- mivi_annotated %>% group_by(group) %>% group_map(~first_seed(.x))

a <- bind_cols(a, do.call(rbind.data.frame, b)[,1]) %>% mutate(fseed = ...3) %>% select(-...3)
a <- remove_missing(a, finite=TRUE)  # remove any Inf's

# Plot with linear model
ggplot(a, aes(mele, fseed)) + geom_point() + geom_smooth(method='lm') +
    ylab("Julian day") + xlab("mean elevation") + labs(title="First Seeding Day by Elevation")

# Q-Q residual plot
model_ele <- lm(fseed~mele, data=a)
res <- resid(model_ele)
qqnorm(res)
qqline(res)

# Pearson's correlation test
cor.test(a$fseed, a$mele, alternative="less")

rm(a, b, res, model_ele)
```

## Tables

```{R}
# All observations by country
table1(~ place_country_name, data=mivi_all %>% mutate(stage=addNA(stage)))

table1(~ latitude + longitude + elevation + julian + place_country_name | stage, data=mivi_all %>% mutate(stage=addNA(stage)))
```


<!--
## Results with different group sizes

```{R, eval=FALSE}
row_names <- c('Number of Groups', 'Lat corr', 'Lat pv', 'Ele corr', 'Ele pv')
lat_corrs <- c(0)
lat_pvs <- c(0)
ele_corrs <- c(0)
ele_pvs <- (0)

df <- data.frame(lat_corrs, lat_pvs, ele_corrs, ele_pvs)
table(df)
format_table(df)
export_table(df)
```
-->


<!--
data <- data.frame("category" = c('Annotated', 'Not Annotated'), "amount" = c(2952, 12066))
ggplot(data, aes(x="", y=amount, fill=category)) +
    geom_bar(stat="identity", width=1) +
    coord_polar("y", start=0)
-->
